<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faros Server - curl Test: Command Output Append</title>
<style>
  :root { --bg: #1e1e2e; --surface: #252536; --border: #3a3a5c; --text: #cdd6f4; --dim: #6c7086; --accent: #89b4fa; --green: #a6e3a1; --red: #f38ba8; --yellow: #f9e2af; --orange: #fab387; --code-bg: #1a1a2e; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.7; padding: 2rem; max-width: 960px; margin: 0 auto; }
  h1 { color: var(--accent); font-size: 1.8rem; margin-bottom: 0.5rem; border-bottom: 2px solid var(--border); padding-bottom: 0.5rem; }
  h2 { color: var(--accent); font-size: 1.3rem; margin-top: 2.5rem; margin-bottom: 0.75rem; }
  h3 { color: var(--yellow); font-size: 1rem; margin-top: 1.5rem; margin-bottom: 0.5rem; }
  p { margin-bottom: 0.75rem; }
  hr { border: none; border-top: 1px solid var(--border); margin: 2rem 0; }
  pre { background: var(--code-bg); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; overflow-x: auto; margin-bottom: 1rem; position: relative; }
  code { font-family: 'JetBrains Mono', 'Fira Code', 'Cascadia Code', monospace; font-size: 0.85rem; color: var(--green); }
  p code { background: var(--code-bg); padding: 0.15em 0.4em; border-radius: 3px; }
  .expect { color: var(--orange); font-weight: 600; margin: 0.5rem 0; }
  .warn { color: var(--red); font-weight: 600; }
  table { border-collapse: collapse; width: 100%; margin: 1rem 0; }
  th { background: var(--surface); color: var(--accent); text-align: left; padding: 0.6rem 0.8rem; border: 1px solid var(--border); }
  td { padding: 0.5rem 0.8rem; border: 1px solid var(--border); }
  tr:nth-child(even) { background: var(--surface); }
  .copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: var(--surface); color: var(--dim); border: 1px solid var(--border); border-radius: 4px; padding: 0.25rem 0.5rem; cursor: pointer; font-size: 0.75rem; }
  .copy-btn:hover { color: var(--accent); border-color: var(--accent); }
  .tag { display: inline-block; font-size: 0.7rem; padding: 0.1rem 0.45rem; border-radius: 3px; font-weight: 600; margin-left: 0.5rem; vertical-align: middle; }
  .tag-200 { background: #1a3a2a; color: var(--green); }
  .tag-400 { background: #3a2a1a; color: var(--orange); }
  .tag-401 { background: #3a1a1a; color: var(--red); }
  .tag-404 { background: #3a1a1a; color: var(--red); }
  .tag-409 { background: #3a2a1a; color: var(--yellow); }
  .tag-201 { background: #1a3a2a; color: var(--green); }
</style>
</head>
<body>

<h1>End-to-End curl Test: Command Output Append</h1>
<p>Test all command endpoints against a running Faros server.</p>

<p><strong>Start the server first:</strong></p>
<pre><code>cd /home/faros/faros-server && .venv/bin/faros-server run</code></pre>

<hr>

<h2>Setup: Register an Agent</h2>

<h3>1. Start device flow</h3>
<pre><code>START=$(curl -s -X POST http://localhost:8000/api/agents/device/start \
  -H 'Content-Type: application/json' \
  -d '{"agent_name": "curl-bot", "robot_type": "px4"}')
echo "START: $START"

DEVICE_CODE=$(echo $START | python3 -c "import sys,json; print(json.load(sys.stdin)['device_code'])")
USER_CODE=$(echo $START | python3 -c "import sys,json; print(json.load(sys.stdin)['user_code'])")
echo "device_code=$DEVICE_CODE  user_code=$USER_CODE"</code></pre>

<h3>2. Approve in browser</h3>
<p>Open the verification URL and click approve:</p>
<pre><code>http://localhost:8000/api/agents/device/&lt;USER_CODE&gt;</code></pre>

<h3>3. Poll for API key</h3>
<pre><code>POLL=$(curl -s -X POST http://localhost:8000/api/agents/device/poll \
  -H 'Content-Type: application/json' \
  -d "{\"device_code\": \"$DEVICE_CODE\"}")
echo "POLL: $POLL"

API_KEY=$(echo $POLL | python3 -c "import sys,json; print(json.load(sys.stdin)['api_key'])")
AGENT_ID=$(echo $POLL | python3 -c "import sys,json; print(json.load(sys.stdin)['agent_id'])")
echo "api_key=$API_KEY  agent_id=$AGENT_ID"</code></pre>

<h3>4. Set auth variables</h3>
<p>Grab the <code>faros_token</code> cookie value from your browser dev tools after OAuth login.</p>
<pre><code>JWT="&lt;paste your faros_token cookie here&gt;"
AUTH_AGENT="Authorization: Bearer $API_KEY"
AUTH_OP="Authorization: Bearer $JWT"</code></pre>

<hr>

<h2>Test 1: Long-Running Command with Output Streaming <span class="tag tag-200">200</span></h2>
<p>Queue a command, stream output while in progress, then ack.</p>

<h3>Operator queues CollectStart</h3>
<pre><code>QUEUED=$(curl -s -X POST http://localhost:8000/api/agents/$AGENT_ID/commands \
  -H 'Content-Type: application/json' -H "$AUTH_OP" \
  -d '{"type": "CollectStart", "payload": {"topics": ["/imu", "/odom"]}}')
echo "QUEUED: $QUEUED"
CMD_ID=$(echo $QUEUED | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")</code></pre>

<h3>Agent polls</h3>
<pre><code>curl -s -X GET http://localhost:8000/api/agents/commands \
  -H "$AUTH_AGENT" | python3 -m json.tool</code></pre>

<h3>Agent streams output while working</h3>
<pre><code>curl -s -X POST http://localhost:8000/api/agents/commands/$CMD_ID/output \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
  -d '{"output": "Recording started...\n"}'

curl -s -X POST http://localhost:8000/api/agents/commands/$CMD_ID/output \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
  -d '{"output": "Collecting bag 1/3...\n"}'

curl -s -X POST http://localhost:8000/api/agents/commands/$CMD_ID/output \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
  -d '{"output": "Collecting bag 2/3...\n"}'

curl -s -X POST http://localhost:8000/api/agents/commands/$CMD_ID/output \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
  -d '{"output": "Collecting bag 3/3...\n"}'</code></pre>

<h3>Operator checks progress mid-flight</h3>
<pre><code>curl -s http://localhost:8000/api/agents/$AGENT_ID/commands/$CMD_ID \
  -H "$AUTH_OP" | python3 -m json.tool</code></pre>
<p class="expect">Expected: status "in_progress", output contains all 4 lines.</p>

<h3>Agent acks</h3>
<pre><code>curl -s -X POST http://localhost:8000/api/agents/commands/$CMD_ID/ack \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
  -d '{"success": true, "message": "3 bags collected"}'</code></pre>

<h3>Operator sees final state</h3>
<pre><code>curl -s http://localhost:8000/api/agents/$AGENT_ID/commands/$CMD_ID \
  -H "$AUTH_OP" | python3 -m json.tool</code></pre>
<p class="expect">Expected: status "acked", output preserved, result.success true.</p>

<hr>

<h2>Test 2: Output on Pending Command <span class="tag tag-409">409</span></h2>

<pre><code>QUEUED2=$(curl -s -X POST http://localhost:8000/api/agents/$AGENT_ID/commands \
  -H 'Content-Type: application/json' -H "$AUTH_OP" \
  -d '{"type": "Status"}')
CMD_ID2=$(echo $QUEUED2 | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")

curl -s -w "\nHTTP %{http_code}\n" \
  -X POST http://localhost:8000/api/agents/commands/$CMD_ID2/output \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
  -d '{"output": "should fail"}'</code></pre>
<p class="expect">Expected: HTTP 409</p>

<hr>

<h2>Test 3: All Unimplemented Command Types <span class="tag tag-200">200</span></h2>
<p>Queue, poll, and ack each command type:</p>

<pre><code>for CMD_TYPE in Discover Validate ModelDeploy ConfigUpdate CollectStart CollectStop Status; do
  echo "--- $CMD_TYPE ---"
  Q=$(curl -s -X POST http://localhost:8000/api/agents/$AGENT_ID/commands \
    -H 'Content-Type: application/json' -H "$AUTH_OP" \
    -d "{\"type\": \"$CMD_TYPE\"}")
  CID=$(echo $Q | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")
  curl -s -X GET http://localhost:8000/api/agents/commands -H "$AUTH_AGENT" &gt; /dev/null
  curl -s -X POST http://localhost:8000/api/agents/commands/$CID/ack \
    -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
    -d "{\"success\": true, \"message\": \"$CMD_TYPE handled\"}"
  echo ""
done</code></pre>

<hr>

<h2>Test 4: List All Commands (Operator View) <span class="tag tag-200">200</span></h2>

<pre><code>curl -s http://localhost:8000/api/agents/$AGENT_ID/commands \
  -H "$AUTH_OP" | python3 -m json.tool</code></pre>

<hr>

<h2>Test 5: Error Cases</h2>

<h3>No auth <span class="tag tag-401">401</span></h3>
<pre><code>curl -s -w "HTTP %{http_code}\n" \
  -X POST http://localhost:8000/api/agents/commands/fake/output \
  -H 'Content-Type: application/json' -d '{"output": "x"}'</code></pre>

<h3>Nonexistent command <span class="tag tag-404">404</span></h3>
<pre><code>curl -s -w "\nHTTP %{http_code}\n" \
  -X POST http://localhost:8000/api/agents/commands/nonexistent/output \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" -d '{"output": "x"}'</code></pre>

<h3>Empty output <span class="tag tag-400">400</span></h3>
<pre><code>curl -s -w "\nHTTP %{http_code}\n" \
  -X POST http://localhost:8000/api/agents/commands/$CMD_ID/output \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" -d '{"output": ""}'</code></pre>

<h3>Output on acked command <span class="tag tag-409">409</span></h3>
<pre><code>curl -s -w "\nHTTP %{http_code}\n" \
  -X POST http://localhost:8000/api/agents/commands/$CMD_ID/output \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" -d '{"output": "too late"}'</code></pre>

<hr>

<h2>Test 6: Heartbeat (Sanity Check) <span class="tag tag-200">200</span></h2>

<pre><code>curl -s -X POST http://localhost:8000/api/agents/heartbeat \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
  -d '{"uptime_s": 120, "cpu_pct": 3.2}'</code></pre>

<hr>

<h2>Test 7: Stop Command <span class="tag tag-200">200</span></h2>

<pre><code>Q=$(curl -s -X POST http://localhost:8000/api/agents/$AGENT_ID/commands \
  -H 'Content-Type: application/json' -H "$AUTH_OP" \
  -d '{"type": "Stop"}')
echo "QUEUED: $Q"
CID=$(echo $Q | python3 -c "import sys,json; print(json.load(sys.stdin)['id'])")

curl -s -X GET http://localhost:8000/api/agents/commands \
  -H "$AUTH_AGENT" | python3 -m json.tool

curl -s -X POST http://localhost:8000/api/agents/commands/$CID/ack \
  -H 'Content-Type: application/json' -H "$AUTH_AGENT" \
  -d '{"success": true, "message": "agent stopping"}'</code></pre>

<hr>

<h2>Test 8: Logout <span class="tag tag-200">200</span> <span class="warn">(DO THIS LAST)</span></h2>
<p>Revokes the API key. Everything after will 401.</p>

<pre><code>curl -s -X POST http://localhost:8000/api/agents/logout -H "$AUTH_AGENT"</code></pre>

<h3>Verify key is dead <span class="tag tag-401">401</span></h3>
<pre><code>curl -s -w "HTTP %{http_code}\n" \
  -X GET http://localhost:8000/api/agents/commands -H "$AUTH_AGENT"</code></pre>

<hr>

<h2>Expected Results Summary</h2>

<table>
<tr><th>Test</th><th>Endpoint</th><th>Expected</th></tr>
<tr><td>1</td><td>POST /output (in_progress)</td><td><span class="tag tag-200">200</span> output accumulates</td></tr>
<tr><td>1</td><td>GET command mid-flight</td><td>output visible, status in_progress</td></tr>
<tr><td>1</td><td>GET command after ack</td><td>output + result preserved</td></tr>
<tr><td>2</td><td>POST /output (pending)</td><td><span class="tag tag-409">409</span></td></tr>
<tr><td>3</td><td>All command types</td><td><span class="tag tag-201">201</span> queue, <span class="tag tag-200">200</span> poll, <span class="tag tag-200">200</span> ack</td></tr>
<tr><td>5</td><td>No auth</td><td><span class="tag tag-401">401</span></td></tr>
<tr><td>5</td><td>Nonexistent</td><td><span class="tag tag-404">404</span></td></tr>
<tr><td>5</td><td>Empty output</td><td><span class="tag tag-400">400</span></td></tr>
<tr><td>5</td><td>Acked command</td><td><span class="tag tag-409">409</span></td></tr>
<tr><td>8</td><td>Logout then poll</td><td><span class="tag tag-200">200</span> then <span class="tag tag-401">401</span></td></tr>
</table>

</body>
</html>
